
(function() {
  $(document).ready(function() {
    var $fakeHeader, $firstHeaderImg, $parallaxBgImg, $parent, $sections, $superContainer, affixHeader, distToTops, lastScrollPos, mainScroll, nthSection, section, sectionHeights, sectionTops;
    $(document).on("touchmove", function(e) {
      return e.preventDefault();
    });
    $sections = $(".section");
    $parent = $sections.parent();
    $superContainer = $(".super-container");
    $fakeHeader = null;
    $firstHeaderImg = $sections.eq(0).find("img");
    $parallaxBgImg = $(".parallax-bg img");
    distToTops = $(".profile-container").offset().top;
    nthSection = null;
    lastScrollPos = 0;
    sectionTops = (function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = $sections.length; _i < _len; _i++) {
        section = $sections[_i];
        _results.push(-$(section).offset().top);
      }
      return _results;
    })();
    sectionHeights = (function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = $sections.length; _i < _len; _i++) {
        section = $sections[_i];
        _results.push($(section).find(".header").height());
      }
      return _results;
    })();
    $firstHeaderImg.css("-webkit-transform", "translate3d(0, -" + distToTops + "px, 0)");
    mainScroll = new IScroll(".super-container", {
      indicators: [
        {
          el: $(".parallax-bg")[0],
          resize: false,
          ignoreBoundaries: true,
          speedRatioY: 0.2
        }
      ],
      HWCompositing: true,
      probeType: 3,
      mouseWheel: true
    });
    mainScroll.on("scrollEnd", function() {});
    mainScroll.on("scroll", function() {
      var diff, displacement;
      if (nthSection === null) {
        if (this.y < sectionTops[0]) {
          nthSection = 0;
          return affixHeader($sections.eq(nthSection));
        } else {
          displacement = this.y * 0.2 - this.y - 200;
          return $firstHeaderImg.css("-webkit-transform", "translate3d(0, " + displacement + "px, 0)");
        }
      } else {
        if (this.y < sectionTops[nthSection + 1]) {
          nthSection += 1;
          return affixHeader($sections.eq(nthSection));
        } else if (this.y < sectionTops[nthSection + 1] + sectionHeights[nthSection + 1]) {
          diff = this.y - sectionTops[nthSection + 1] - sectionHeights[nthSection + 1];
          return $fakeHeader.css("-webkit-transform", "translate3d(0, " + diff + "px, 0)");
        } else if (this.y > sectionTops[nthSection]) {
          if (nthSection === 0) {
            if ($fakeHeader) {
              $fakeHeader.remove();
              $fakeHeader = null;
              return nthSection = null;
            }
          } else {
            nthSection -= 1;
            return affixHeader($sections.eq(nthSection));
          }
        } else {
          return $fakeHeader.css("-webkit-transform", "translate3d(0, 0, 0)");
        }
      }
    });
    return affixHeader = function($section) {
      if ($fakeHeader) {
        $fakeHeader.remove();
      }
      return $fakeHeader = $section.find(".header").clone().addClass("affixed").appendTo($superContainer);
    };
  });

}).call(this);